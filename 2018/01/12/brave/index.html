<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.0 -->
    <script>
        window.materialVersion = "1.5.0"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Title -->
    
    <title>
        
            Brave之Trace、Span | 
        
        Misaniy | Note
    </title>

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Misaniy Wu">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="">

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(window.oldVersion){var remove=window.oldVersion.reduce(function(p,c){return p||data.indexOf("/*"+c+"*/")!==-1},false);if(remove){lsloader.removeLS(key)}}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload,isJs){if(typeof cssonload==="boolean"){isJs=cssonload;cssonload=undefined}isJs=isJs||false;cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload,isJs);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload,isJs);return}code=code.split(versionString)[1];if(isJs){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload,isJs)}};lsloader.requestResource=function(name,path,cssonload,isJs){var that=this;if(isJs){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else{this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Misaniy | Note">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icon -->

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://misaniy.cc">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Brave之Trace、Span | Misaniy | Note">
    <meta property="og:image" content="http://misaniy.cc/img/favicon.png" />
    <meta property="og:description" content="">
    

    
        <meta property="article:published_time" content="Fri Jan 12 2018 16:20:15 GMT+0800" />
        <meta property="article:modified_time" content="Tue Jan 16 2018 00:03:29 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="Brave之Trace、Span | Misaniy | Note">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="http://misaniy.cc/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://misaniy.cc" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://misaniy.cc/2018/01/12/brave/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://misaniy.cc/2018/01/12/brave/index.html",
    "headline": "Brave之Trace、Span",
    "datePublished": "Fri Jan 12 2018 16:20:15 GMT+0800",
    "dateModified": "Tue Jan 16 2018 00:03:29 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Misaniy Wu",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "一个人知道自己为什么而活,就能忍受任何一种生活"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Misaniy | Note",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": "",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Trace"><span class="post-toc-number">1.</span> <span class="post-toc-text">Trace</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Span"><span class="post-toc-number">2.</span> <span class="post-toc-text">Span</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#RealSpan"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">RealSpan</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Recorder"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Recorder</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#BoundedAsyncReporter"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">BoundedAsyncReporter</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ByteBoundedQueue"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">ByteBoundedQueue</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#offer"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">offer</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#drainTo"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">drainTo</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#doDrain"><span class="post-toc-number">2.4.3.</span> <span class="post-toc-text">doDrain</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#clear"><span class="post-toc-number">2.4.4.</span> <span class="post-toc-text">clear</span></a></li></ol></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Brave之Trace、Span
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Misaniy Wu</strong>
        <span>1月 12, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Brave之Trace、Span&url=http://misaniy.cc/2018/01/12/brave/index.html&pic=http://misaniy.cc/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Brave之Trace、Span&url=http://misaniy.cc/2018/01/12/brave/index.html&via=Misaniy Wu" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://misaniy.cc/2018/01/12/brave/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://misaniy.cc/2018/01/12/brave/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Misaniy | Note&title=Brave之Trace、Span&summary=&pics=http://misaniy.cc/img/favicon.png&url=http://misaniy.cc/2018/01/12/brave/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>Brave是Java版的Zipkin客户端，它将收集的跟踪信息，以Span的形式上报给Zipkin系统。有趣的是，Dapper荷兰语意寓“勇敢”,这也是Brave命名原因。</p>
<h2 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h2><p>我们一般不会手动编写Trace相关的代码，Brave提供了一些开箱即用的库，来帮助我们对某些特定的库类来进行追踪，比如Servlet，SpringMVC，MySQL，OkHTTP,HttpClient等，这些都可以在brave的Git上找到  <a href="https://github.com/openzipkin/brave/tree/master/instrumentation" target="_blank" rel="external">Brave</a></p>
<p>我们先来看看一个简单的Demo来演示下Brave的基本使用，这对我们后续分析Brave的原理和其他类库的使用有很大帮助</p>
<p>TraceDemo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">package com.example.trancedemo;</div><div class="line"></div><div class="line">/**</div><div class="line"> * @Author:Misaniy</div><div class="line"> * @Date:2018/1/15</div><div class="line"> */</div><div class="line">import brave.Span;</div><div class="line">import brave.Tracer;</div><div class="line">import brave.Tracing;</div><div class="line">import brave.context.log4j2.ThreadContextCurrentTraceContext;</div><div class="line">import brave.propagation.B3Propagation;</div><div class="line">import brave.propagation.ExtraFieldPropagation;</div><div class="line">import zipkin2.codec.SpanBytesEncoder;</div><div class="line">import zipkin2.reporter.AsyncReporter;</div><div class="line">import zipkin2.reporter.Sender;</div><div class="line">import zipkin2.reporter.okhttp3.OkHttpSender;</div><div class="line"></div><div class="line">import java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line">public class TraceDemo &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Sender sender = OkHttpSender.create(&quot;http://10.10.20.54:9411/api/v2/spans&quot;);</div><div class="line">        AsyncReporter asyncReporter = AsyncReporter.builder(sender)</div><div class="line">                .closeTimeout(500, TimeUnit.MILLISECONDS)</div><div class="line">                .build(SpanBytesEncoder.JSON_V2);</div><div class="line"></div><div class="line">        Tracing tracing = Tracing.newBuilder()</div><div class="line">                .localServiceName(&quot;tracer-demo&quot;)</div><div class="line">                .spanReporter(asyncReporter)</div><div class="line">                .propagationFactory(ExtraFieldPropagation.newFactory(B3Propagation.FACTORY, &quot;user-name&quot;))</div><div class="line">                .currentTraceContext(ThreadContextCurrentTraceContext.create())</div><div class="line">                .build();</div><div class="line"></div><div class="line">        Tracer tracer = tracing.tracer();</div><div class="line">        Span span = tracer.newTrace().name(&quot;encode&quot;).start();</div><div class="line">        try &#123;</div><div class="line">            doSomethingExpensive();</div><div class="line">        &#125; finally &#123;</div><div class="line">            span.finish();</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        Span twoPhase = tracer.newTrace().name(&quot;twoPhase&quot;).start();</div><div class="line">        try &#123;</div><div class="line">            Span prepare = tracer.newChild(twoPhase.context()).name(&quot;prepare&quot;).start();</div><div class="line">            try &#123;</div><div class="line">                prepare();</div><div class="line">            &#125; finally &#123;</div><div class="line">                prepare.finish();</div><div class="line">            &#125;</div><div class="line">            Span commit = tracer.newChild(twoPhase.context()).name(&quot;commit&quot;).start();</div><div class="line">            try &#123;</div><div class="line">                commit();</div><div class="line">            &#125; finally &#123;</div><div class="line">                commit.finish();</div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            twoPhase.finish();</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        sleep(1000);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void doSomethingExpensive() &#123;</div><div class="line">        sleep(500);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void commit() &#123;</div><div class="line">        sleep(500);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void prepare() &#123;</div><div class="line">        sleep(500);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void sleep(long milliseconds) &#123;</div><div class="line">        try &#123;</div><div class="line">            TimeUnit.MILLISECONDS.sleep(milliseconds);</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>启动Zipkin，然后运行TraceDemo，在Zipkin的UI界面中能查到两条跟踪信息<br><img src="https://i.imgur.com/ykbyZWI.png" alt=""><br>点击第一条跟踪信息，可以看到有一条Span(encode)，耗时500ms左右<br><img src="https://i.imgur.com/oJgEG9W.png" alt=""><br>本条跟踪信息对应代码片段为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Span span = tracer.newTrace().name(&quot;encode&quot;).start();</div><div class="line">        try &#123;</div><div class="line">            doSomethingExpensive();</div><div class="line">        &#125; finally &#123;</div><div class="line">            span.finish();</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>由Tracer创建一个新的Span,名为encode，然后调用start方法开始计时，之后运行一个耗时500ms的方法，最后调用finish方法结束技术，完成并记录一条跟踪信息。</p>
</blockquote>
<p>这段代码实际上向Zipkin上报的数据为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    &quot;traceId&quot;: &quot;e6543a966b3d57c7&quot;,</div><div class="line">    &quot;id&quot;: &quot;e6543a966b3d57c7&quot;,</div><div class="line">    &quot;name&quot;: &quot;encode&quot;,</div><div class="line">    &quot;timestamp&quot;: 1515985702794744,</div><div class="line">    &quot;duration&quot;: 499986,</div><div class="line">    &quot;binaryAnnotations&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: &quot;lc&quot;,</div><div class="line">        &quot;value&quot;: &quot;&quot;,</div><div class="line">        &quot;endpoint&quot;: &#123;</div><div class="line">          &quot;serviceName&quot;: &quot;tracer-demo&quot;,</div><div class="line">          &quot;ipv4&quot;: &quot;192.168.233.1&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>然后我们再来看第二条稍微复杂的跟踪信息，可以看到一条名为twoPhase的Span，总耗时为1000ms,它有两个子Span，分别名为prepare和commit，两者分别耗时500ms<br><img src="https://i.imgur.com/z6eeyXC.png" alt=""><br>这条跟踪信息对应的代码片段为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Span twoPhase = tracer.newTrace().name(&quot;twoPhase&quot;).start();</div><div class="line">try &#123;</div><div class="line">    Span prepare = tracer.newChild(twoPhase.context()).name(&quot;prepare&quot;).start();</div><div class="line">    try &#123;</div><div class="line">        prepare();</div><div class="line">    &#125; finally &#123;</div><div class="line">        prepare.finish();</div><div class="line">    &#125;</div><div class="line">    Span commit = tracer.newChild(twoPhase.context()).name(&quot;commit&quot;).start();</div><div class="line">    try &#123;</div><div class="line">        commit();</div><div class="line">    &#125; finally &#123;</div><div class="line">        commit.finish();</div><div class="line">    &#125;</div><div class="line">&#125; finally &#123;</div><div class="line">    twoPhase.finish();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码实际上向Zipkin上报的数据为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    &quot;traceId&quot;: &quot;28235705afd01d6b&quot;,</div><div class="line">    &quot;id&quot;: &quot;28235705afd01d6b&quot;,</div><div class="line">    &quot;name&quot;: &quot;twophase&quot;,</div><div class="line">    &quot;timestamp&quot;: 1515985703345044,</div><div class="line">    &quot;duration&quot;: 1024396,</div><div class="line">    &quot;binaryAnnotations&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: &quot;lc&quot;,</div><div class="line">        &quot;value&quot;: &quot;&quot;,</div><div class="line">        &quot;endpoint&quot;: &#123;</div><div class="line">          &quot;serviceName&quot;: &quot;tracer-demo&quot;,</div><div class="line">          &quot;ipv4&quot;: &quot;192.168.233.1&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    &quot;traceId&quot;: &quot;28235705afd01d6b&quot;,</div><div class="line">    &quot;id&quot;: &quot;a5d7e0c73fd3c876&quot;,</div><div class="line">    &quot;name&quot;: &quot;prepare&quot;,</div><div class="line">    &quot;parentId&quot;: &quot;28235705afd01d6b&quot;,</div><div class="line">    &quot;timestamp&quot;: 1515985703347497,</div><div class="line">    &quot;duration&quot;: 519107,</div><div class="line">    &quot;binaryAnnotations&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: &quot;lc&quot;,</div><div class="line">        &quot;value&quot;: &quot;&quot;,</div><div class="line">        &quot;endpoint&quot;: &#123;</div><div class="line">          &quot;serviceName&quot;: &quot;tracer-demo&quot;,</div><div class="line">          &quot;ipv4&quot;: &quot;192.168.233.1&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    &quot;traceId&quot;: &quot;28235705afd01d6b&quot;,</div><div class="line">    &quot;id&quot;: &quot;930b1e149af8c7a9&quot;,</div><div class="line">    &quot;name&quot;: &quot;commit&quot;,</div><div class="line">    &quot;parentId&quot;: &quot;28235705afd01d6b&quot;,</div><div class="line">    &quot;timestamp&quot;: 1515985703866753,</div><div class="line">    &quot;duration&quot;: 502585,</div><div class="line">    &quot;binaryAnnotations&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: &quot;lc&quot;,</div><div class="line">        &quot;value&quot;: &quot;&quot;,</div><div class="line">        &quot;endpoint&quot;: &#123;</div><div class="line">          &quot;serviceName&quot;: &quot;tracer-demo&quot;,</div><div class="line">          &quot;ipv4&quot;: &quot;192.168.233.1&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h2 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h2><p>首先来看下Span的实现类RealSpan</p>
<h3 id="RealSpan"><a href="#RealSpan" class="headerlink" title="RealSpan"></a>RealSpan</h3><p>RealSpan两个核心方法start,finish<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">abstract Recorder recorder();</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">public Span start() &#123;</div><div class="line">       this.recorder().start(this.context());</div><div class="line">       return this;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   public Span start(long timestamp) &#123;</div><div class="line">       this.recorder().start(this.context(), timestamp);</div><div class="line">       return this;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">public void finish() &#123;</div><div class="line">       this.recorder().finish(this.context());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">public void finish(long timestamp) &#123;</div><div class="line">       this.recorder().finish(this.context(), timestamp);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>分别调用Recorder的start方法和finish方法</p>
<h3 id="Recorder"><a href="#Recorder" class="headerlink" title="Recorder"></a>Recorder</h3><p>该类记录Span</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">final MutableSpanMap spanMap;</div><div class="line">   final Reporter&lt;Span&gt; reporter;</div><div class="line">   final AtomicBoolean noop;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">   public void start(TraceContext context) &#123;</div><div class="line">       if (!this.noop.get()) &#123;</div><div class="line">           this.spanMap.getOrCreate(context).start();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   public void start(TraceContext context, long timestamp) &#123;</div><div class="line">       if (!this.noop.get()) &#123;</div><div class="line">           this.spanMap.getOrCreate(context).start(timestamp);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   public void finish(TraceContext context) &#123;</div><div class="line">       MutableSpan span = this.spanMap.remove(context);</div><div class="line">       if (span != null &amp;&amp; !this.noop.get()) &#123;</div><div class="line">           synchronized(span) &#123;</div><div class="line">               span.finish(span.clock.currentTimeMicroseconds());</div><div class="line">               this.reporter.report(span.toSpan());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   public void finish(TraceContext context, long finishTimestamp) &#123;</div><div class="line">       MutableSpan span = this.spanMap.remove(context);</div><div class="line">       if (span != null &amp;&amp; !this.noop.get()) &#123;</div><div class="line">           synchronized(span) &#123;</div><div class="line">               span.finish(finishTimestamp);</div><div class="line">               this.reporter.report(span.toSpan());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>Recorder的start方法是获取跟TraceContext绑定的Span信息，记录开始时间和结束时间,并在finish时，调用reporter的report方法，上报给Zipkin.这里看出Repoter用于记录Span.其中</p>
<blockquote>
<p><strong>AtomicBoolean</strong>: AtomicBoolean是java.util.concurrent.atomic包下的原子变量，这个包里面提供了一组原子类。其基本的特性就是在多线程环境下，当有多个线程同时执行这些类的实例包含的方法时，具有排他性，即当某个线程进入方法，执行其中的指令时，不会被其他线程打断，而别的线程就像自旋锁一样，一直等到该方法执行完成，才由JVM从等待队列中选择一个另一个线程进入，这只是一种逻辑上的理解。实际上是借助硬件的相关指令来实现的，不会阻塞线程(或者说只是在硬件级别上阻塞了)。</p>
</blockquote>
<h3 id="BoundedAsyncReporter"><a href="#BoundedAsyncReporter" class="headerlink" title="BoundedAsyncReporter"></a>BoundedAsyncReporter</h3><p>Reporter的实现类AsyncReporter，而AsyncReporter的实现类是BoundedAsyncReporter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">static final Logger logger = Logger.getLogger(AsyncReporter.BoundedAsyncReporter.class.getName());</div><div class="line">        final AtomicBoolean closed = new AtomicBoolean(false);</div><div class="line">        final BytesEncoder&lt;S&gt; encoder;</div><div class="line">        final ByteBoundedQueue&lt;S&gt; pending;</div><div class="line">        final Sender sender;</div><div class="line">        final int messageMaxBytes;</div><div class="line">        final long messageTimeoutNanos;</div><div class="line">        final long closeTimeoutNanos;</div><div class="line">        final CountDownLatch close;</div><div class="line">        final ReporterMetrics metrics;</div><div class="line"></div><div class="line">        BoundedAsyncReporter(AsyncReporter.Builder builder, BytesEncoder&lt;S&gt; encoder) &#123;</div><div class="line">            this.pending = new ByteBoundedQueue(builder.queuedMaxSpans, builder.queuedMaxBytes);</div><div class="line">            this.sender = builder.sender;</div><div class="line">            this.messageMaxBytes = builder.messageMaxBytes;</div><div class="line">            this.messageTimeoutNanos = builder.messageTimeoutNanos;</div><div class="line">            this.closeTimeoutNanos = builder.closeTimeoutNanos;</div><div class="line">            this.close = new CountDownLatch(builder.messageTimeoutNanos &gt; 0L ? 1 : 0);</div><div class="line">            this.metrics = builder.metrics;</div><div class="line">            this.encoder = encoder;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>BoundedAsyncReporter中的几个重要的类</p>
<blockquote>
<ul>
<li><strong>BytesEncoder</strong>——Span的编码器，将Span编码成二进制，便于sender发送给Zipkin</li>
<li><strong>ByteBoundedQueue</strong>——一个既有数量限制，又有字节数限制的阻塞队列</li>
<li><strong>Sender</strong>——将编码后的二进制数据，发送给Zipkin</li>
<li><strong>Reportermetrics</strong>——Span的report相关的统计信息</li>
<li><strong>BufferNextMessage</strong>——Consumer，Span信息的消费者，依靠Sender上报Span信息</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public void report(S next) &#123;</div><div class="line">            if (next == null) &#123;</div><div class="line">                throw new NullPointerException(&quot;span == null&quot;);</div><div class="line">            &#125; else &#123;</div><div class="line">                this.metrics.incrementSpans(1);</div><div class="line">                int nextSizeInBytes = this.encoder.sizeInBytes(next);</div><div class="line">                int messageSizeOfNextSpan = this.sender.messageSizeInBytes(nextSizeInBytes);</div><div class="line">                this.metrics.incrementSpanBytes(nextSizeInBytes);</div><div class="line">                if (this.closed.get() || messageSizeOfNextSpan &gt; this.messageMaxBytes || !this.pending.offer(next, nextSizeInBytes)) &#123;</div><div class="line">                    this.metrics.incrementSpansDropped(1);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>report方法，将span转化成字节数组，然后计算出messageSize,添加到queue(pending)中，并记录相应的统计信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">public &lt;S&gt; AsyncReporter&lt;S&gt; build(BytesEncoder&lt;S&gt; encoder) &#123;</div><div class="line">            if (encoder == null) &#123;</div><div class="line">                throw new NullPointerException(&quot;encoder == null&quot;);</div><div class="line">            &#125; else if (encoder.encoding() != this.sender.encoding()) &#123;</div><div class="line">                throw new IllegalArgumentException(String.format(&quot;Encoder doesn&apos;t match Sender: %s %s&quot;, encoder.encoding(), this.sender.encoding()));</div><div class="line">            &#125; else &#123;</div><div class="line">                final AsyncReporter.BoundedAsyncReporter&lt;S&gt; result = new AsyncReporter.BoundedAsyncReporter(this, encoder);</div><div class="line">                if (this.messageTimeoutNanos &gt; 0L) &#123;</div><div class="line">                    final BufferNextMessage&lt;S&gt; consumer = BufferNextMessage.create(this.sender, this.messageMaxBytes, this.messageTimeoutNanos);</div><div class="line">                    Thread flushThread = new Thread(&quot;AsyncReporter&#123;&quot; + this.sender + &quot;&#125;&quot;) &#123;</div><div class="line">                        public void run() &#123;</div><div class="line">                            while(true) &#123;</div><div class="line">                                boolean var5 = false;</div><div class="line"></div><div class="line">                                try &#123;</div><div class="line">                                    var5 = true;</div><div class="line">                                    if (!result.closed.get()) &#123;</div><div class="line">                                        result.flush(consumer);</div><div class="line">                                        continue;</div><div class="line">                                    &#125;</div><div class="line"></div><div class="line">                                    var5 = false;</div><div class="line">                                &#125; finally &#123;</div><div class="line">                                    if (var5) &#123;</div><div class="line">                                        int count = consumer.count();</div><div class="line">                                        if (count &gt; 0) &#123;</div><div class="line">                                            Builder.this.metrics.incrementSpansDropped(count);</div><div class="line">                                            AsyncReporter.BoundedAsyncReporter.logger.warning(&quot;Dropped &quot; + count + &quot; spans due to AsyncReporter.close()&quot;);</div><div class="line">                                        &#125;</div><div class="line"></div><div class="line">                                        result.close.countDown();</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line"></div><div class="line">                                int countx = consumer.count();</div><div class="line">                                if (countx &gt; 0) &#123;</div><div class="line">                                    Builder.this.metrics.incrementSpansDropped(countx);</div><div class="line">                                    AsyncReporter.BoundedAsyncReporter.logger.warning(&quot;Dropped &quot; + countx + &quot; spans due to AsyncReporter.close()&quot;);</div><div class="line">                                &#125;</div><div class="line"></div><div class="line">                                result.close.countDown();</div><div class="line">                                return;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;;</div><div class="line">                    flushThread.setDaemon(true);</div><div class="line">                    flushThread.start();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return result;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>只有当messageTimeoutNanos&gt;0时，才会启动线程flushThread，循环调用BoundedAsyncReporter的flush方法，将内存中的Span信息上报给Zipkin。</p>
<p>再来看看BoundedAsyncReporter中的close方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public void close() &#123;</div><div class="line">           if (this.closed.compareAndSet(false, true)) &#123;</div><div class="line">               try &#123;</div><div class="line">                   if (!this.close.await(this.closeTimeoutNanos, TimeUnit.NANOSECONDS)) &#123;</div><div class="line">                       logger.warning(&quot;Timed out waiting for in-flight spans to send&quot;);</div><div class="line">                   &#125;</div><div class="line">               &#125; catch (InterruptedException var2) &#123;</div><div class="line">                   logger.warning(&quot;Interrupted waiting for in-flight spans to send&quot;);</div><div class="line">                   Thread.currentThread().interrupt();</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               int count = this.pending.clear();</div><div class="line">               if (count &gt; 0) &#123;</div><div class="line">                   this.metrics.incrementSpansDropped(count);</div><div class="line">                   logger.warning(&quot;Dropped &quot; + count + &quot; spans due to AsyncReporter.close()&quot;);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>这个close方法和Thread中的While循环呼应，在close方法中，首先将closed变量置为true，然后调用close.await()，等待close信号量（CountDownLatch）的释放，此处代码会阻塞，一直到Thread中finally中调用result.close.countDown();<br>而在close方法中将closed变量置为true后，Thread中的while循环将结束执行，然后执行finally代码块，系统会将内存中还未上报的Span添加到Queue(result.pending)中，然后调用result.close.countDown();close方法中阻塞的代码会继续执行，将调用metrics.incrementSpansDropped(count)将这些Span的数量添加到metrics统计信息中。</p>
</blockquote>
<p>接下来看看两个flush方法，其中flush()是public的，供外部手动调用，而flush(BufferNextMessage bundler)是在Thread中循环调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public final void flush() &#123;</div><div class="line">           this.flush(BufferNextMessage.create(this.sender, this.messageMaxBytes, 0L));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       void flush(BufferNextMessage&lt;S&gt; bundler) &#123;</div><div class="line">           if (this.closed.get()) &#123;</div><div class="line">               throw new IllegalStateException(&quot;closed&quot;);</div><div class="line">           &#125; else &#123;</div><div class="line">               this.pending.drainTo(bundler, bundler.remainingNanos());</div><div class="line">               this.metrics.updateQueuedSpans(this.pending.count);</div><div class="line">               this.metrics.updateQueuedBytes(this.pending.sizeInBytes);</div><div class="line">               if (bundler.isReady() || this.closed.get()) &#123;</div><div class="line">                   this.metrics.incrementMessages();</div><div class="line">                   this.metrics.incrementMessageBytes(bundler.sizeInBytes());</div><div class="line">                   final ArrayList&lt;byte[]&gt; nextMessage = new ArrayList(bundler.count());</div><div class="line">                   bundler.drain(new SpanWithSizeConsumer&lt;S&gt;() &#123;</div><div class="line">                       public boolean offer(S next, int nextSizeInBytes) &#123;</div><div class="line">                           nextMessage.add(BoundedAsyncReporter.this.encoder.encode(next));</div><div class="line">                           if (BoundedAsyncReporter.this.sender.messageSizeInBytes(nextMessage) &gt; BoundedAsyncReporter.this.messageMaxBytes) &#123;</div><div class="line">                               nextMessage.remove(nextMessage.size() - 1);</div><div class="line">                               return false;</div><div class="line">                           &#125; else &#123;</div><div class="line">                               return true;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line"></div><div class="line">                   try &#123;</div><div class="line">                       this.sender.sendSpans(nextMessage).execute();</div><div class="line">                   &#125; catch (RuntimeException | Error | IOException var5) &#123;</div><div class="line">                       int count = nextMessage.size();</div><div class="line">                       Call.propagateIfFatal(var5);</div><div class="line">                       this.metrics.incrementMessagesDropped(var5);</div><div class="line">                       this.metrics.incrementSpansDropped(count);</div><div class="line">                       if (logger.isLoggable(Level.FINE)) &#123;</div><div class="line">                           logger.log(Level.FINE, String.format(&quot;Dropped %s spans due to %s(%s)&quot;, count, var5.getClass().getSimpleName(), var5.getMessage() == null ? &quot;&quot; : var5.getMessage()), var5);</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       if (var5 instanceof IllegalStateException) &#123;</div><div class="line">                           throw (IllegalStateException)var5;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>先将队列pending中的数据，全部提取到BufferNextMessage(bundler)中，直到bundler满为止<br>当bundler准备好，即isReady()返回true，将bundler中的message全部取出来<br>将取出来的所有message，调用Sender的sendSpans方法，发送到Zipkin</p>
</blockquote>
<h3 id="ByteBoundedQueue"><a href="#ByteBoundedQueue" class="headerlink" title="ByteBoundedQueue"></a>ByteBoundedQueue</h3><p>是一个既有数量限制，又有字节数限制的阻塞队列，提供了offer，drainTo，clear三个方法，供调用者向queue里存放，提取和清空数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">final class ByteBoundedQueue&#123;</div><div class="line">final ReentrantLock lock = new ReentrantLock(false);</div><div class="line">    final Condition available;</div><div class="line">    final int maxSize;</div><div class="line">    final int maxBytes;</div><div class="line">    final S[] elements;</div><div class="line">    final int[] sizesInBytes;</div><div class="line">    int count;</div><div class="line">    int sizeInBytes;</div><div class="line">    int writePos;</div><div class="line">    int readPos;</div><div class="line"></div><div class="line">    ByteBoundedQueue(int maxSize, int maxBytes) &#123;</div><div class="line">        this.available = this.lock.newCondition();</div><div class="line">        this.elements = new Object[maxSize];</div><div class="line">        this.sizesInBytes = new int[maxSize];</div><div class="line">        this.maxSize = maxSize;</div><div class="line">        this.maxBytes = maxBytes;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ByteBoundedQueue接受两个int参数，maxSize是queue接收的最大数量，maxBytes是queue接收的最大字节数。<br>ByteBoundedQueue中使用一个二维byte数组elements来存储message，并使用writePos和readPos两个游标，分别记录写和读的位置。<br>ByteBoundedQueue中使用了最典型的可重入锁ReetrantLock，使offer，drainTo，clear等方法是线程安全的</p>
<h4 id="offer"><a href="#offer" class="headerlink" title="offer"></a>offer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">public boolean offer(S next, int nextSizeInBytes) &#123;</div><div class="line">        this.lock.lock();</div><div class="line"></div><div class="line">        boolean var3;</div><div class="line">        try &#123;</div><div class="line">            if (this.count != this.maxSize) &#123;</div><div class="line">                if (this.sizeInBytes + nextSizeInBytes &gt; this.maxBytes) &#123;</div><div class="line">                    var3 = false;</div><div class="line">                    return var3;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                this.elements[this.writePos] = next;</div><div class="line">                this.sizesInBytes[this.writePos++] = nextSizeInBytes;</div><div class="line">                if (this.writePos == this.maxSize) &#123;</div><div class="line">                    this.writePos = 0;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ++this.count;</div><div class="line">                this.sizeInBytes += nextSizeInBytes;</div><div class="line">                this.available.signal();</div><div class="line">                var3 = true;</div><div class="line">                return var3;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            var3 = false;</div><div class="line">        &#125; finally &#123;</div><div class="line">            this.lock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return var3;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>offer方法是添加message到queue中，使用了标准的<strong>try-lock</strong>结构，即先获取锁，然后finally里释放锁，在获取锁后，比较count和maxSize,当count和maxSize相等时代表是满的，不能添加，只有不满时才能添加，然后比较sizeInBytes+nextSizeInBytes&gt;maxBytes，如果成立，表示添加后会超过限制，也不能添加，如果这几个条件都不满足，则可以继续添加，将writePos++，并将message放于writePos+1处，当writePos到达maxSize后，则将writePos置为0，让下一次添加从数组头部开始，然后将count计数器加1，并更新字节总数，然后调用available.signal()来通知其他在lock上等待的线程（在drainTo方法中阻塞的线程）继续竞争线程资源</p>
<h4 id="drainTo"><a href="#drainTo" class="headerlink" title="drainTo"></a>drainTo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">int drainTo(SpanWithSizeConsumer&lt;S&gt; consumer, long nanosTimeout) &#123;</div><div class="line">        try &#123;</div><div class="line">            this.lock.lockInterruptibly();</div><div class="line"></div><div class="line">            int var12;</div><div class="line">            try &#123;</div><div class="line">                for(long nanosLeft = nanosTimeout; this.count == 0; nanosLeft = this.available.awaitNanos(nanosLeft)) &#123;</div><div class="line">                    if (nanosLeft &lt;= 0L) &#123;</div><div class="line">                        byte var6 = 0;</div><div class="line">                        return var6;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                var12 = this.doDrain(consumer);</div><div class="line">            &#125; finally &#123;</div><div class="line">                this.lock.unlock();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return var12;</div><div class="line">        &#125; catch (InterruptedException var11) &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>drainTo方法是提取message到Consumer中消费，如果当时queue里没有消息，则每次等待nanosTimeout，直到queue里存入消息为止<br>当while循环退出，表明queue中已经有新的message添加进来，可以消费，则调用doRain方法</p>
</blockquote>
<h4 id="doDrain"><a href="#doDrain" class="headerlink" title="doDrain"></a>doDrain</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">int doDrain(SpanWithSizeConsumer&lt;S&gt; consumer) &#123;</div><div class="line">        int drainedCount = 0;</div><div class="line">        int drainedSizeInBytes = 0;</div><div class="line"></div><div class="line">        while(drainedCount &lt; this.count) &#123;</div><div class="line">            S next = this.elements[this.readPos];</div><div class="line">            int nextSizeInBytes = this.sizesInBytes[this.readPos];</div><div class="line">            if (next == null || !consumer.offer(next, nextSizeInBytes)) &#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ++drainedCount;</div><div class="line">            drainedSizeInBytes += nextSizeInBytes;</div><div class="line">            this.elements[this.readPos] = null;</div><div class="line">            if (++this.readPos == this.elements.length) &#123;</div><div class="line">                this.readPos = 0;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        this.count -= drainedCount;</div><div class="line">        this.sizeInBytes -= drainedSizeInBytes;</div><div class="line">        return drainedCount;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>doDrain里依然是一个while循环，当drainedCount&lt;count,即提取的message数量总数小于queue里消息总数时，尝试调用consumer.accept方法<br>如果accept方法返回true，则将drainedCount加1，并且drainedSizeInBytes加上当前消息的字节数nextSizeInBytes<br>如果<code>!drainedCount&lt;count</code>，则跳出循环，将queue的count减掉提取的总消息数<br>drainedCount，sizeInBytes减去提取的总字节数drainedSizeInBytes</p>
</blockquote>
<h4 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">int clear() &#123;</div><div class="line">        this.lock.lock();</div><div class="line"></div><div class="line">        int var2;</div><div class="line">        try &#123;</div><div class="line">            int result = this.count;</div><div class="line">            this.count = this.sizeInBytes = this.readPos = this.writePos = 0;</div><div class="line">            Arrays.fill(this.elements, (Object)null);</div><div class="line">            var2 = result;</div><div class="line">        &#125; finally &#123;</div><div class="line">            this.lock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return var2;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>clear方法，清空队列。这个方法比较简单，就是将所有东西清零。该方法在Repoter的close方法中会被使用。</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/01/11/zipkin/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Misaniy Wu's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        misaniy@hotmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: misaniy@hotmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Jenkins/">Jenkins<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/Web集/">Web集<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/ZipKin/">ZipKin<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Zipkin/">Zipkin<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/springboot/">springboot<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/分享集/">分享集<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/categories/基本集/">基本集<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/基础集/">基础集<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/报错集/">报错集<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/数据库集/">数据库集<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/categories/框架集/">框架集<span class="sidebar_archives-count">6</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">43</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="http://github.com/Misaniy" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2017&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Misaniy | Note
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("sm_js","/js/smoothscroll.js?lOy/ACj5suSNi7ZVFVbpFQ==", true)</script>
    











<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
